<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/manager_default}">
<head>
	<script th:inline="javascript"> 
	
	
		function categoryChange(num){
			console.log(num.value);
			var num = num.value;
			var target = document.getElementById("sub_category");
			var category = new Array();
			if(num == "none"){
				var opt = document.createElement("option");
				var text = "=== 선택 ===";
				category[0] = text;
				opt.value = category[0];
				opt.innerHTML = category[0];
				target.appendChild(opt);
			}
			const subcategory = [[${subCateList}]];
			
			
			for(var i = 0; i<subcategory.length; i++){
				if(subcategory[i].category==num){
					console.log(subcategory[i].sub_category_name);
					category[i] = subcategory[i].sub_category_name;
				}
			}
			
			target.options.length = 0;
			
			for(x in category){
				var opt = document.createElement("option");
				opt.value = category[x];
				opt.innerHTML = category[x];
				target.appendChild(opt);
				
			}
			
			console.log($("#main_category").val());
			console.log($("#frm").serialize());
		}
		
	</script>
	<script>
		var textsss = "";
		$(document).ready(function() {
		  $("#summernote").summernote({
	 	    	placeholder: '입력해 주세요',
	 	    	//width :1000,
		        minHeight: 500,
		        maxHeight: null,
		        focus: true, 
		        lang : 'ko-KR',
		        toolbar: [
				    // 글꼴 설정
				    ['fontname', ['fontname']],
				    // 글자 크기 설정
				    ['fontsize', ['fontsize']],
				    // 굵기, 기울임꼴, 밑줄,취소 선, 서식지우기
				    ['style', ['bold', 'italic', 'underline','strikethrough', 'clear']],
				    // 글자색
				    ['color', ['forecolor','color']],
				    // 표만들기
				    ['table', ['table']],
				    // 글머리 기호, 번호매기기, 문단정렬
				    ['para', ['ul', 'ol', 'paragraph']],
				    // 줄간격
				    ['height', ['height']],
				    // 그림첨부, 링크만들기, 동영상첨부
				    ['insert',['picture','link','video']],
				    // 코드보기, 확대해서보기, 도움말
				    ['view', ['codeview', 'help']]
				  ],
				  // 추가한 글꼴
				fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New','맑은 고딕','궁서','굴림체','굴림','돋음체','바탕체'],
				 // 추가한 폰트사이즈
				fontSizes: ['8','9','10','11','12','14','16','18','20','22','24','28','30','36','50','72'],
				callbacks: {	//여기 부분이 이미지를 첨부하는 부분
					/* onImageUpload : function(files) {
						uploadSummernoteImageFile(files[0],this);
					},
					onPaste: function (e) {
						var clipboardData = e.originalEvent.clipboardData;
						if (clipboardData && clipboardData.items && clipboardData.items.length) {
							var item = clipboardData.items[0];
							if (item.kind === 'file' && item.type.indexOf('image/') !== -1) {
								e.preventDefault();
							}
						}
					} */
					onChange:function(contents, $editable){ //텍스트 글자수 및 이미지등록개수
						console.log(contents);
		                setContentsLength(contents, 0);
		            }
				}
				});
		});
		function setContentsLength(str, index) {
		    var status = false;
		    var textCnt = 0; //총 글자수
		    var maxCnt = 1000; //최대 글자수
		    var editorText = f_SkipTags_html(str); //에디터에서 태그를 삭제하고 내용만 가져오기
		    textsss = editorText;
		    
		    editorText = editorText.replace(/\s/gi,""); //줄바꿈 제거
		    
		    editorText = editorText.replace(/&nbsp;/gi, ""); //공백제거

	        textCnt = editorText.length;
		    if(maxCnt > 0) {
	        	if(textCnt > maxCnt) {
	                status = true;
	        	}
		    }
			console.log(textCnt);
		    if(status) {
	        	var msg = "등록오류 : 글자수는 최대 "+maxCnt+"까지 등록이 가능합니다. / 현재 글자수 : "+textCnt+"자";
	        	console.log(msg);
		    }
		}
		
		//에디터 내용 텍스트 제거
		function f_SkipTags_html(input, allowed) {
			// 허용할 태그는 다음과 같이 소문자로 넘겨받습니다. (<a><b><c>)
		    allowed = (((allowed || "") + "").toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join('');
		    var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,
		    commentsAndPhpTags = /<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
		    return input.replace(commentsAndPhpTags, '').replace(tags, function ($0, $1) {
		        return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
		    });
		}
		
		$(function(){
			var target = document.getElementById("main_category");
	        $('#submit').on("click",function () {
	        	console.log(textsss);
	        	if(target.options[target.selectedIndex].value==""){
	        		alert("카테고리를 골라주세요");
	        	}else{
	        		var form1 = $("#form").serializeArray(false);
		            var form2 = $("#form").serialize();
		            var contents = form1[3].value;
		            console.log(contents);
		            const reg = /<[^>]*>?/g
		        	var text = contents.replace(reg," ");	
		            form2 += "&text="+ textsss;
		            console.log(form2);
		            console.log(textsss);
		            
		            $.ajax({
		                type: "post",
		                url: "/manager/boardInsert",
		                data: form2,
		                dataType: 'json',
		                success: function (form2) {
		                    alert("success");
		                    console.log(form2);
		                    window.location.href = "/manager/manager";
		                },
		                error: function (request, status, error) {
		                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);

		                }
		            });
	        	}
	            
	        });
	    });
		
		
		/**
		* 이미지 파일 업로드
		*/
		function uploadSummernoteImageFile(file, editor) {
			data = new FormData();
			data.append("file", file);
			console.log(data);
			$.ajax({
				data : data,
				type : "POST",
				url : "/uploadSummernoteImageFile",
				contentType : false,
				processData : false,
				enctype : 'multipart/form-data',
				success : function(data) {
	            	//항상 업로드된 파일의 url이 있어야 한다.
					$(editor).summernote('insertImage', data.url);
				},
				error : function(e){
					console.log(e);
				}
			});
		}
	</script>
	<style>
		
	</style>
</head>

	
<div layout:fragment="content">
	<div id="mainPage">
		<div class="container manager-container">
			<h2>기사 쓰기</h2>
	    	<form id="form" name="form" method="post" action="/manager/boardInsert" enctype="multipart/form-data">
	    		
	    		<table class="board_detail">
					<tr>
						<td>제목</td>
						<td><input type="text" id="title" name="title"/></td>
					</tr>
					<tr>
						<td>작성자</td>
						<td th:text = "${username}"></td>
					</tr>
					<tr>
						<td>카테고리</td>
						<!--  <td><input type="text" id="category" name="category" disabled/></td>-->
						<td>
						  <select  id="main_category" name="category" class="categorys" onchange="categoryChange(this)">
						    <option value="" disabled selected>=== 선택 ===</option>
						    <option th:each="mainCateList : ${mainCateList}" th:value = "${mainCateList.category}" th:name = "${mainCateList.category_name}" th:utext="${mainCateList.category_name}"></option> <!-- 보도/대학 -->
						    <!-- <option th:value = "${mainCateList[1].category}" th:name = "${mainCateList[1].category_name}" th:text="${mainCateList[1].category_name}"></option> 사회
						    <option th:value = "${mainCateList[2].category}" th:name = "${mainCateList[2].category_name}" th:text="${mainCateList[2].category_name}"></option> 종합 문화
						    <option th:value = "${mainCateList[3].category}" th:name = "${mainCateList[3].category_name}" th:text="${mainCateList[3].category_name}"></option> 종합 문화 -->
						  </select>
						  
						  <select id="sub_category" name="subcategory" class="categorys">
						    <option value="none">=== 선택 ===</option>
						    <!-- <option value="univ" th:text="${subCateList[0].sub_category_name}"></option> 보도/대학
						    <option value="social" th:text="${subCateList[1].sub_category_name}"></option> 사회
						    <option value="culture" th:text="${subCateList[2].sub_category_name}"></option> 종합 문화 -->
						  </select>
						</td>
						
					</tr>
					<tr>
						<td colspan="4">
							<textarea id="summernote" name="contents"></textarea>
						</td>
						
					</tr>
					
				</table>
				<div class="filechooser">
					<!-- <span>대표 사진 : </span>
					<input type="file" id="files" name="files" multiple="multiple"> -->
					<button type="button" id="submit" value="저장" class="btn btn-outline-primary">저장</button>
				</div>
	    	</form>
		
		</div>
	</div>
</div>

</html>